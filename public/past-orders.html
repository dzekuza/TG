<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Past Orders</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <span class="title">Past Orders</span>
    </div>
    <div id="past-orders-section" class="order-section"></div>
  </div>
  <script type="module">
    async function renderPastOrders() {
      const tgUser = Telegram.WebApp.initDataUnsafe.user;
      const pastOrdersSection = document.getElementById('past-orders-section');
      if (!tgUser) {
        pastOrdersSection.innerHTML = '<div class="order-history-item">Please log in to view past orders.</div>';
        return;
      }
      pastOrdersSection.innerHTML = '<div class="order-history-item">Loading...</div>';
      try {
        const res = await fetch(`/api/orders?user_id=${tgUser.id}`);
        const data = await res.json();
        if (!data.orders || !data.orders.length) {
          pastOrdersSection.innerHTML = '<div class="order-history-item">No past orders yet.</div>';
          return;
        }
        pastOrdersSection.innerHTML = data.orders.map(order => {
          let items = '';
          try {
            const parsed = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
            items = Array.isArray(parsed)
              ? parsed.map(i => `${i.emoji ? i.emoji + ' ' : ''}${i.name || i.meal || ''}${i.qty ? ' x' + i.qty : ''}`).join(', ')
              : order.items;
          } catch { items = order.items; }
          let status = order.status ? `<div>Status: <b>${order.status}</b></div>` : '';
          let eta = order.eta ? `<div>ETA: <b>${order.eta} min</b></div>` : '';
          let created = order.created_at ? `<div class='order-time'>${new Date(order.created_at).toLocaleString()}</div>` : '';
          return `<div class='order-history-item'>
            <div><b>Order ID:</b> ${order.order_id}</div>
            <div><b>Items:</b> ${items}</div>
            <div><b>Comment:</b> ${order.comment || '-'}</div>
            ${status}
            ${eta}
            ${created}
          </div>`;
        }).join('');
      } catch (e) {
        pastOrdersSection.innerHTML = '<div class="order-history-item">Failed to load past orders.</div>';
      }
    }
    Telegram.WebApp.ready();
    renderPastOrders();
  </script>
</body>
</html>
