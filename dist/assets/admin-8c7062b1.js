import{c as H,r as a,j as e,a as ee,M as se,C as q,A as te,b as re,T as K,P as B,d as ae,R as le}from"./index-1d49bd17.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=H("Inbox",[["polyline",{points:"22 12 16 12 14 15 10 15 8 12 2 12",key:"o97t9d"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=H("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]),oe=m=>{switch(m){case"pending":return{icon:e.jsx(q,{className:"w-4 h-4"}),label:"Pending",bgColor:"bg-yellow-100",textColor:"text-yellow-700",borderColor:"border-yellow-200"};case"preparing":return{icon:e.jsx(B,{className:"w-4 h-4"}),label:"Preparing",bgColor:"bg-blue-100",textColor:"text-blue-700",borderColor:"border-blue-200"};case"on-the-way":case"arriving":return{icon:e.jsx(K,{className:"w-4 h-4"}),label:"On the way",bgColor:"bg-orange-100",textColor:"text-orange-700",borderColor:"border-orange-200"};case"delivered":case"arrived":return{icon:e.jsx(re,{className:"w-4 h-4"}),label:"Delivered",bgColor:"bg-green-100",textColor:"text-green-700",borderColor:"border-green-200"};case"cancelled":return{icon:e.jsx(te,{className:"w-4 h-4"}),label:"Cancelled",bgColor:"bg-red-100",textColor:"text-red-700",borderColor:"border-red-200"};default:return{icon:e.jsx(q,{className:"w-4 h-4"}),label:m||"Unknown",bgColor:"bg-gray-100",textColor:"text-gray-700",borderColor:"border-gray-200"}}},de=m=>new Date(m).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});function ce(){const[m,N]=a.useState([]),[f,x]=a.useState(!0),[n,o]=a.useState({}),[c,p]=a.useState("pending"),[t,h]=a.useState({}),[u,O]=a.useState({}),[i,g]=a.useState(""),[r,y]=a.useState(!1),[P,v]=a.useState(""),[_,k]=a.useState("orders"),[C,U]=a.useState(""),[A,I]=a.useState(!1),[$,l]=a.useState(""),w=[{key:"pending",label:"Pending"},{key:"arriving",label:"On the way"},{key:"arrived",label:"Delivered"},{key:"cancelled",label:"Cancelled"}],R=[{value:"pending",label:"Pending"},{value:"arriving",label:"On the way"},{value:"arrived",label:"Delivered"},{value:"cancelled",label:"Cancelled"}],J="mainadmin";a.useEffect(()=>{T()},[]);const T=async(s=i)=>{try{x(!0);const b=await fetch(`/api/admin-orders?password=${encodeURIComponent(s)}`);if(b.status===401){v("Incorrect password"),y(!1),x(!1);return}v(""),y(!0);const E=await b.json();if(E.orders){N(E.orders);const d={},j={};E.orders.forEach(S=>{d[S.user_id]=S.admin_note||"",j[S.user_id]=(j[S.user_id]||0)+1}),h(d),O(j)}}catch{v("Error loading orders"),y(!1),x(!1)}finally{x(!1)}},M=async(s,b,E="",d="",j="",S="",L="")=>{o(D=>({...D,[s]:!0}));try{(await fetch("/api/admin-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order_id:s,status:b,comment:E,eta:d,driver_location:j,admin_note:S,user_id:L})})).ok?await T():alert("Failed to update order status")}catch(D){console.error("Error updating order:",D),alert("Error updating order status")}finally{o(D=>({...D,[s]:!1}))}},W=async(s,b)=>{await M(s.order_id,b,s.comment,s.eta,s.driver_location,t[s.user_id],s.user_id)},G=(s,b)=>{h(E=>({...E,[s]:b}))},V=async s=>{await M(s.order_id,s.status,s.comment,s.eta,s.driver_location,t[s.user_id],s.user_id)},Y=async(s,b)=>{await M(s.order_id,s.status,s.comment,String(b),s.driver_location,t[s.user_id],s.user_id)},Q=async s=>{if(window.confirm("Are you sure you want to remove this order?")){o(b=>({...b,[s]:!0}));try{(await fetch("/api/admin-orders",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({order_id:s,password:i})})).ok?N(E=>E.filter(d=>d.order_id!==s)):alert("Failed to remove order")}catch{alert("Error removing order")}finally{o(b=>({...b,[s]:!1}))}}},X=()=>e.jsx("div",{className:"sticky top-0 z-10 bg-white border-b border-gray-200 mb-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto flex gap-2 px-4 py-2",children:[e.jsxs("button",{onClick:()=>k("orders"),className:`flex-1 flex flex-col items-center gap-1 py-2 px-3 rounded-xl transition-colors ${_==="orders"?"bg-blue-50 text-blue-600":"text-gray-600 hover:text-gray-800"}`,children:[e.jsx(B,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-semibold",children:"Orders"})]}),e.jsxs("button",{onClick:()=>k("messages"),className:`flex-1 flex flex-col items-center gap-1 py-2 px-3 rounded-xl transition-colors ${_==="messages"?"bg-blue-50 text-blue-600":"text-gray-600 hover:text-gray-800"}`,children:[e.jsx(ne,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-semibold",children:"Messages"})]}),e.jsxs("button",{onClick:()=>k("route"),className:`flex-1 flex flex-col items-center gap-1 py-2 px-3 rounded-xl transition-colors ${_==="route"?"bg-blue-50 text-blue-600":"text-gray-600 hover:text-gray-800"}`,children:[e.jsx(K,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-semibold",children:"Route"})]}),e.jsxs("button",{onClick:()=>k("admin"),className:`flex-1 flex flex-col items-center gap-1 py-2 px-3 rounded-xl transition-colors ${_==="admin"?"bg-blue-50 text-blue-600":"text-gray-600 hover:text-gray-800"}`,children:[e.jsx(ie,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-semibold",children:"âš¡ Admin"})]})]})}),Z=()=>e.jsx("div",{className:"min-h-[300px] flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-lg w-full max-w-xs flex flex-col gap-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 text-center",children:"Main Admin Login"}),e.jsx("input",{type:"password",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter main admin password",value:C,onChange:s=>U(s.target.value),onKeyDown:s=>{s.key==="Enter"&&z()},autoFocus:!0}),$&&e.jsx("div",{className:"text-red-600 text-sm text-center",children:$}),e.jsx("button",{className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg",onClick:z,children:"Login"})]})}),z=()=>{C===J?(I(!0),l("")):(l("Incorrect password"),I(!1))};return r?f?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading orders..."})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[X(),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-6",children:[_==="orders"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto mb-6",children:e.jsx("div",{className:"flex gap-2 min-w-max w-full",children:w.map(s=>e.jsx("button",{onClick:()=>p(s.key),className:`flex-1 px-4 py-2 rounded-lg font-medium border transition-colors whitespace-nowrap ${c===s.key?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-200 hover:bg-gray-100"}`,style:{minWidth:120},children:s.label},s.key))})}),m.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“¦"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No orders yet"}),e.jsx("p",{className:"text-gray-600",children:"Orders will appear here when customers place them"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:m.filter(s=>c==="pending"?s.status==="pending":c==="arriving"?s.status==="arriving"||s.status==="on-the-way":c==="arrived"?s.status==="arrived"||s.status==="delivered":c==="cancelled"?s.status==="cancelled":!0).map(s=>{const b=oe(s.status);let E="";try{const d=typeof s.items=="string"?JSON.parse(s.items):s.items;E=Array.isArray(d)?d.map(j=>{const S=j.name||j.meal||"",L=j.qty?` x${j.qty}`:"";return`${j.emoji?j.emoji+" ":""}${S}${S.includes("x")?"":L}`}).join(`
`):s.items}catch{E=s.items}return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{children:[e.jsxs("div",{className:`flex items-center gap-1.5 px-3 py-1 rounded-full border mb-1 ${b.bgColor} ${b.textColor} ${b.borderColor}`,children:[b.icon,e.jsx("span",{className:"text-sm font-medium",children:b.label})]}),e.jsxs("div",{className:"flex items-center gap-1 text-gray-500 text-sm",children:[e.jsx(ee,{className:"w-4 h-4"}),e.jsx("span",{children:de(s.created_at)})]})]})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Order Items:"}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-3",children:e.jsx("p",{className:"text-gray-700 whitespace-pre-line",children:E})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Total:"}),e.jsx("div",{className:"bg-blue-50 rounded-lg p-3 border border-blue-100",children:e.jsxs("span",{className:"text-blue-800 font-semibold",children:["â‚¬",s.total||"0.00"]})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"User:"}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 flex flex-col gap-1",children:[e.jsxs("span",{className:"text-gray-700",children:["ID: ",s.user_id]}),e.jsxs("span",{className:"text-gray-700",children:["Orders placed: ",u[s.user_id]||1]})]})]}),s.comment&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Comment:"}),e.jsx("div",{className:"bg-blue-50 rounded-lg p-3 border border-blue-100",children:e.jsx("p",{className:"text-blue-800",children:s.comment})})]}),s.location&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Location:"}),(()=>{let d=s.location;try{typeof d=="string"&&(d=JSON.parse(d))}catch{}const j=(d==null?void 0:d.manual)||d;let S=null,L=null,D=!1;if(typeof j=="string"){let F=j.match(/@([\d.\-]+),([\d.\-]+)/);F||(F=j.match(/q=([\d.\-]+),([\d.\-]+)/)),F&&(S=F[1],L=F[2],D=!0)}return D&&S&&L?e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("iframe",{title:"Map",width:"100%",height:"200",className:"rounded-lg border",src:`https://maps.google.com/maps?q=${S},${L}&z=15&output=embed`,allowFullScreen:!0}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("a",{href:`https://waze.com/ul?ll=${S},${L}&navigate=yes`,target:"_blank",rel:"noopener noreferrer",className:"bg-blue-100 text-blue-700 px-3 py-2 rounded-xl text-xs font-semibold hover:bg-blue-200",children:"Go with Waze"}),e.jsx("a",{href:j,target:"_blank",rel:"noopener noreferrer",className:"bg-gray-100 text-gray-700 px-3 py-2 rounded-xl text-xs font-semibold hover:bg-gray-200",children:"Open in Maps"})]})]}):e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsx("span",{children:typeof d=="string"?d:JSON.stringify(d)})]})})()]}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Update Status:"}),e.jsx("select",{value:s.status,onChange:d=>W(s,d.target.value),disabled:n[s.order_id],className:"w-full px-3 py-2 border border-blue-400 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-blue-50 text-blue-900 font-semibold shadow-sm transition-all",children:R.map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ETA (minutes):"}),e.jsx("input",{type:"text",placeholder:"e.g., 15",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",defaultValue:s.eta||"",onBlur:d=>M(s.order_id,s.status,s.comment,d.target.value,s.driver_location,t[s.user_id],s.user_id)})]})]}),e.jsx("div",{className:"flex gap-2 mb-4",children:[10,5,2].map(d=>e.jsxs("button",{onClick:()=>Y(s,d),className:"px-3 py-1 rounded-lg bg-blue-100 text-blue-700 font-semibold hover:bg-blue-200 border border-blue-200 transition-colors",disabled:n[s.order_id],children:[d," min"]},d))}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Admin Note (private):"}),e.jsx("textarea",{className:"w-full rounded-lg border border-gray-300 p-2 text-gray-800 bg-yellow-50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400",rows:2,value:t[s.user_id]||"",onChange:d=>G(s.user_id,d.target.value),onBlur:()=>V(s),placeholder:"Add a private note about this user..."})]}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx("button",{className:"px-3 py-1 rounded-lg bg-red-100 text-red-700 font-semibold hover:bg-red-200 border border-red-200 transition-colors text-sm",onClick:()=>Q(s.order_id),disabled:n[s.order_id],children:"Remove Order"})}),n[s.order_id]&&e.jsxs("div",{className:"mt-4 flex items-center gap-2 text-blue-600",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm",children:"Updating..."})]})]},s.order_id)})})]}),_==="messages"&&e.jsx("div",{className:"min-h-[300px] flex flex-col items-center justify-center text-gray-700",children:e.jsxs("div",{className:"bg-white rounded-xl shadow p-6 w-full max-w-lg",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Admin Chat"}),e.jsx(ue,{adminPassword:i})]})}),_==="route"&&e.jsx("div",{className:"min-h-[300px] flex flex-col items-center justify-center text-gray-700",children:e.jsxs("div",{className:"bg-white rounded-xl shadow p-6 w-full max-w-2xl",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Route Optimizer"}),e.jsx(be,{orders:m})]})}),_==="admin"&&(A?e.jsxs("div",{className:"min-h-[300px] flex flex-col items-center justify-center text-gray-700",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Driver Stats"}),e.jsx("div",{className:"bg-white rounded-xl shadow p-6 w-full max-w-4xl text-center mb-8",children:e.jsx(xe,{mainAdminPassword:C})}),e.jsxs("div",{className:"bg-white rounded-xl shadow p-6 w-full max-w-4xl mb-8",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Product Management"}),e.jsx(he,{mainAdminPassword:C})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow p-6 w-full max-w-lg",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Admin Users"}),e.jsx(me,{mainAdminPassword:C})]})]}):Z())]})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-lg w-full max-w-xs flex flex-col gap-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 text-center",children:"Admin Login"}),e.jsx("input",{type:"password",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter admin password",value:i,onChange:s=>g(s.target.value),onKeyDown:s=>{s.key==="Enter"&&T()},autoFocus:!0}),P&&e.jsx("div",{className:"text-red-600 text-sm text-center",children:P}),e.jsx("button",{className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg",onClick:()=>T(),children:"Login"})]})})}function me({mainAdminPassword:m}){const[N,f]=a.useState([]),[x,n]=a.useState(""),[o,c]=a.useState(""),[p,t]=a.useState(!1),[h,u]=a.useState(""),O=async()=>{t(!0),u("");try{const r=await fetch(`/api/admin-users?password=${encodeURIComponent(m)}`);if(!r.ok)throw new Error("Failed to fetch users");const y=await r.json();f(y.users||[])}catch{u("Error loading users")}finally{t(!1)}};a.useEffect(()=>{O()},[]);const i=async()=>{if(!x)return u("User ID required");t(!0),u("");try{if(!(await fetch("/api/admin-users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:x,nickname:o,password:m})})).ok)throw new Error("Failed to add user");n(""),c(""),O()}catch{u("Error adding user")}finally{t(!1)}},g=async r=>{if(window.confirm("Remove this admin user?")){t(!0),u("");try{if(!(await fetch("/api/admin-users",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:r,password:m})})).ok)throw new Error("Failed to remove user");O()}catch{u("Error removing user")}finally{t(!1)}}};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx("input",{className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg",placeholder:"User ID",value:x,onChange:r=>n(r.target.value)}),e.jsx("input",{className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Nickname (optional)",value:o,onChange:r=>c(r.target.value)}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold disabled:opacity-50",onClick:i,disabled:p,children:"Add"})]}),h&&e.jsx("div",{className:"text-red-600 text-sm mb-2",children:h}),e.jsx("ul",{className:"divide-y divide-gray-200",children:N.map(r=>e.jsxs("li",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{className:"flex flex-col text-left",children:[e.jsx("span",{className:"font-mono text-sm",children:r.user_id}),r.nickname&&e.jsx("span",{className:"text-xs text-gray-500",children:r.nickname})]}),e.jsx("button",{className:"text-red-600 hover:underline text-xs",onClick:()=>g(r.user_id),disabled:p,children:"Remove"})]},r.user_id))})]})}function xe({mainAdminPassword:m}){const[N,f]=a.useState([]),[x,n]=a.useState(!1),[o,c]=a.useState("");a.useEffect(()=>{n(!0),c(""),fetch(`/api/admin-users?stats=1&password=${encodeURIComponent(m)}`).then(t=>t.json()).then(t=>{f(t.stats||[]),n(!1)}).catch(()=>{c("Error loading stats"),n(!1)})},[m]);const p={};return N.forEach(t=>{p[t.user_id]||(p[t.user_id]={orders:0,profit:0,hours:0,km:0,nickname:t.nickname}),p[t.user_id].orders+=Number(t.orders_delivered||0),p[t.user_id].profit+=Number(t.profit||0),p[t.user_id].hours+=Number(t.hours_worked||0),p[t.user_id].km+=Number(t.km_driven||0)}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"All Drivers - Stats"}),x?e.jsx("div",{className:"text-gray-500",children:"Loading..."}):o?e.jsx("div",{className:"text-red-600",children:o}):e.jsxs(e.Fragment,{children:[e.jsxs("table",{className:"min-w-full text-xs md:text-sm border",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"px-2 py-1 border",children:"User ID"}),e.jsx("th",{className:"px-2 py-1 border",children:"Nickname"}),e.jsx("th",{className:"px-2 py-1 border",children:"Date"}),e.jsx("th",{className:"px-2 py-1 border",children:"Orders"}),e.jsx("th",{className:"px-2 py-1 border",children:"Profit (â‚¬)"}),e.jsx("th",{className:"px-2 py-1 border",children:"Hours"}),e.jsx("th",{className:"px-2 py-1 border",children:"KM"})]})}),e.jsx("tbody",{children:N.map((t,h)=>e.jsxs("tr",{className:"even:bg-gray-50",children:[e.jsx("td",{className:"px-2 py-1 border font-mono",children:t.user_id}),e.jsx("td",{className:"px-2 py-1 border",children:t.nickname||"-"}),e.jsx("td",{className:"px-2 py-1 border",children:t.date}),e.jsx("td",{className:"px-2 py-1 border text-center",children:t.orders_delivered}),e.jsx("td",{className:"px-2 py-1 border text-right",children:Number(t.profit).toFixed(2)}),e.jsx("td",{className:"px-2 py-1 border text-center",children:t.hours_worked}),e.jsx("td",{className:"px-2 py-1 border text-center",children:t.km_driven})]},h))})]}),e.jsx("h4",{className:"mt-6 mb-2 text-left font-semibold",children:"Totals per Driver"}),e.jsxs("table",{className:"min-w-full text-xs md:text-sm border",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"px-2 py-1 border",children:"User ID"}),e.jsx("th",{className:"px-2 py-1 border",children:"Nickname"}),e.jsx("th",{className:"px-2 py-1 border",children:"Orders"}),e.jsx("th",{className:"px-2 py-1 border",children:"Profit (â‚¬)"}),e.jsx("th",{className:"px-2 py-1 border",children:"Hours"}),e.jsx("th",{className:"px-2 py-1 border",children:"KM"})]})}),e.jsx("tbody",{children:Object.entries(p).map(([t,h])=>e.jsxs("tr",{className:"even:bg-gray-50",children:[e.jsx("td",{className:"px-2 py-1 border font-mono",children:t}),e.jsx("td",{className:"px-2 py-1 border",children:h.nickname||"-"}),e.jsx("td",{className:"px-2 py-1 border text-center",children:h.orders}),e.jsx("td",{className:"px-2 py-1 border text-right",children:h.profit.toFixed(2)}),e.jsx("td",{className:"px-2 py-1 border text-center",children:h.hours}),e.jsx("td",{className:"px-2 py-1 border text-center",children:h.km})]},t))})]})]})]})}function ue({adminPassword:m}){const N=m||"admin",f="Admin",[x,n]=a.useState([]),[o,c]=a.useState(""),[p,t]=a.useState(!1),[h,u]=a.useState(""),O=a.useRef(null),i=async()=>{try{const y=await(await fetch("/api/admin-messages")).json();n(y.messages||[])}catch{u("Error loading messages")}};a.useEffect(()=>{i();const r=setInterval(i,5e3);return()=>clearInterval(r)},[]),a.useEffect(()=>{var r;(r=O.current)==null||r.scrollIntoView({behavior:"smooth"})},[x]);const g=async()=>{if(o.trim()){t(!0),u("");try{if(!(await fetch("/api/admin-messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:N,nickname:f,message:o})})).ok)throw new Error("Failed to send");c(""),i()}catch{u("Error sending message")}finally{t(!1)}}};return e.jsxs("div",{className:"flex flex-col h-96",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto border rounded-lg p-2 bg-gray-50 mb-2",children:[x.map(r=>e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-mono text-xs text-gray-500",children:r.nickname||r.user_id}),e.jsx("span",{className:"ml-2 text-xs text-gray-400",children:new Date(r.created_at).toLocaleTimeString()}),e.jsx("div",{className:"text-sm text-gray-800 bg-white rounded p-2 shadow-sm inline-block mt-1",children:r.message})]},r.id)),e.jsx("div",{ref:O})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Type a message...",value:o,onChange:r=>c(r.target.value),onKeyDown:r=>{r.key==="Enter"&&g()},disabled:p}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold disabled:opacity-50",onClick:g,disabled:p||!o.trim(),children:"Send"})]}),h&&e.jsx("div",{className:"text-red-600 text-sm mt-2",children:h})]})}function he({mainAdminPassword:m}){const[N,f]=a.useState([]),[x,n]=a.useState(null),[o,c]=a.useState({name:"",price_1:"",price_2:"",price_3:"",image_url:"",available:!0}),[p,t]=a.useState(!1),[h,u]=a.useState(""),[O,i]=a.useState([]),[g,r]=a.useState("month"),[y,P]=a.useState(""),v=async()=>{t(!0),u("");try{const w=await(await fetch("/api/products")).json();f(w.products||[])}catch{u("Error loading products")}finally{t(!1)}},_=async()=>{try{const w=await(await fetch(`/api/products-stats?period=${g}`)).json();i(w.stats||[])}catch{}};a.useEffect(()=>{v()},[]),a.useEffect(()=>{_()},[g]);const k=l=>{const{name:w,value:R,type:J,checked:T}=l.target;c(M=>({...M,[w]:J==="checkbox"?T:R}))},C=l=>{n(l.id),c({name:l.name,price_1:l.price_1||"",price_2:l.price_2||"",price_3:l.price_3||"",image_url:l.image_url||"",available:l.available}),P(l.image_url||"")},U=()=>{n(null),c({name:"",price_1:"",price_2:"",price_3:"",image_url:"",available:!0}),P("")},A=async()=>{t(!0),u("");try{const l=x?"PUT":"POST",w={...o,price_1:o.price_1?Number(o.price_1):null,price_2:o.price_2?Number(o.price_2):null,price_3:o.price_3?Number(o.price_3):null,password:m};if(x&&(w.id=x),!(await fetch("/api/products",{method:l,headers:{"Content-Type":"application/json"},body:JSON.stringify(w)})).ok)throw new Error("Failed to save");v(),U()}catch{u("Error saving product")}finally{t(!1)}},I=async l=>{if(window.confirm("Remove this product?")){t(!0),u("");try{if(!(await fetch("/api/products",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:l,password:m})})).ok)throw new Error("Failed to remove");v()}catch{u("Error removing product")}finally{t(!1)}}},$=async l=>{const w=l.target.files[0];if(w){P(URL.createObjectURL(w)),u(""),t(!0);try{const R=new FormData;R.append("file",w);const T=await(await fetch("/api/upload",{method:"POST",body:R})).json();T.url?c(M=>({...M,image_url:T.url})):u("Image upload failed")}catch{u("Image upload failed")}finally{t(!1)}}};return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4 flex flex-col gap-3",children:[e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",name:"name",placeholder:"Product name",value:o.name,onChange:k}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",name:"price_1",type:"number",min:"0",step:"0.01",placeholder:"Price for 1 piece (â‚¬)",value:o.price_1,onChange:k}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",name:"price_2",type:"number",min:"0",step:"0.01",placeholder:"Price for 2 pieces (â‚¬)",value:o.price_2,onChange:k}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",name:"price_3",type:"number",min:"0",step:"0.01",placeholder:"Price for 3 pieces (â‚¬)",value:o.price_3,onChange:k})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"file",accept:"image/*",className:"block",onChange:$}),y&&e.jsx("img",{src:y,alt:"Preview",className:"w-16 h-16 object-cover rounded"})]}),e.jsxs("label",{className:"flex items-center gap-1 text-xs",children:[e.jsx("input",{type:"checkbox",name:"available",checked:o.available,onChange:k})," Available"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold disabled:opacity-50",onClick:A,disabled:p||!o.name||!o.price_1,children:x?"Save":"Add"}),x&&e.jsx("button",{className:"flex-1 text-xs text-gray-500 hover:underline",onClick:U,children:"Cancel"})]})]}),h&&e.jsx("div",{className:"text-red-600 text-sm mb-2",children:h}),e.jsx("div",{className:"overflow-x-auto mb-6",children:e.jsxs("table",{className:"min-w-full text-xs md:text-sm border shadow rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"px-2 py-1 border",children:"ID"}),e.jsx("th",{className:"px-2 py-1 border",children:"Name"}),e.jsx("th",{className:"px-2 py-1 border",children:"Price 1pc (â‚¬)"}),e.jsx("th",{className:"px-2 py-1 border",children:"Price 2pcs (â‚¬)"}),e.jsx("th",{className:"px-2 py-1 border",children:"Price 3pcs (â‚¬)"}),e.jsx("th",{className:"px-2 py-1 border",children:"Image"}),e.jsx("th",{className:"px-2 py-1 border",children:"Available"}),e.jsx("th",{className:"px-2 py-1 border",children:"Actions"})]})}),e.jsx("tbody",{children:N.map(l=>e.jsxs("tr",{className:"even:bg-gray-50 hover:bg-blue-50 transition-colors",children:[e.jsx("td",{className:"px-2 py-1 border text-center",children:l.id}),e.jsx("td",{className:"px-2 py-1 border font-semibold",children:l.name}),e.jsx("td",{className:"px-2 py-1 border text-right",children:l.price_1?Number(l.price_1).toFixed(2):"-"}),e.jsx("td",{className:"px-2 py-1 border text-right",children:l.price_2?Number(l.price_2).toFixed(2):"-"}),e.jsx("td",{className:"px-2 py-1 border text-right",children:l.price_3?Number(l.price_3).toFixed(2):"-"}),e.jsx("td",{className:"px-2 py-1 border text-center",children:l.image_url&&e.jsx("img",{src:l.image_url,alt:"",className:"w-10 h-10 object-cover rounded"})}),e.jsx("td",{className:"px-2 py-1 border text-center",children:l.available?"Yes":"No"}),e.jsxs("td",{className:"px-2 py-1 border text-center",children:[e.jsx("button",{className:"text-blue-600 hover:underline text-xs mr-2",onClick:()=>C(l),children:"Edit"}),e.jsx("button",{className:"text-red-600 hover:underline text-xs",onClick:()=>I(l.id),children:"Remove"})]})]},l.id))})]})}),e.jsxs("div",{className:"mb-2 flex gap-2 items-center",children:[e.jsx("span",{className:"text-xs",children:"Stats period:"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-xs",value:g,onChange:l=>r(l.target.value),children:[e.jsx("option",{value:"day",children:"Day"}),e.jsx("option",{value:"week",children:"Week"}),e.jsx("option",{value:"month",children:"Month"})]})]}),e.jsx(pe,{stats:O,period:g})]})}function pe({stats:m,period:N}){const f={};m.forEach(n=>{f[n.name]||(f[n.name]=[]),f[n.name].push({period:n.period,count:Number(n.count)})});const x=Array.from(new Set(m.map(n=>n.period))).sort();return e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-xs md:text-sm border",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"px-2 py-1 border",children:"Product"}),x.map(n=>e.jsx("th",{className:"px-2 py-1 border",children:String(n).slice(0,10)},n))]})}),e.jsx("tbody",{children:Object.entries(f).map(([n,o])=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-2 py-1 border font-semibold",children:n}),x.map(c=>{const p=o.find(t=>t.period===c);return e.jsx("td",{className:"px-2 py-1 border text-center",children:p?p.count:0},c)})]},n))})]})})}function be({orders:m}){const[N,f]=a.useState([]),[x,n]=a.useState(!1),[o,c]=a.useState(""),[p,t]=a.useState({}),h=m.filter(i=>i.status==="pending"||i.status==="arriving");function u(i){try{typeof i=="string"&&(i=JSON.parse(i))}catch{}if(i.lat&&i.lng)return[Number(i.lat),Number(i.lng)];if(i.manual&&typeof i.manual=="string"){const g=i.manual.match(/@([\d.\-]+),([\d.\-]+)/)||i.manual.match(/q=([\d.\-]+),([\d.\-]+)/);if(g)return[Number(g[1]),Number(g[2])]}return null}const O=async()=>{if(n(!0),c(""),f([]),t({}),!navigator.geolocation){c("Geolocation not supported"),n(!1);return}navigator.geolocation.getCurrentPosition(async i=>{const g=i.coords.latitude,r=i.coords.longitude,y=h.map(P=>P.order_id);if(!y.length){c("No active orders to optimize"),n(!1);return}try{const v=await(await fetch("/api/optimize-route",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order_ids:y,driver_location:{lat:g,lng:r}})})).json();if(!v.route){c("No route found"),n(!1);return}f(v.route);const _={};v.route.forEach((k,C)=>{_[k]=v.etas&&v.etas[C]?v.etas[C]:""}),t(_);for(const[k,C]of v.route.entries()){const U=_[C],A=h.find(I=>I.order_id===C);A&&await fetch("/api/admin-orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order_id:C,status:A.status,comment:A.comment,eta:String(U),driver_location:JSON.stringify(u(A.location)),admin_note:A.admin_note,user_id:A.user_id})})}}catch{c("Failed to optimize route")}finally{n(!1)}},i=>{c("Failed to get driver location"),n(!1)})};return e.jsxs("div",{children:[e.jsx("div",{className:"mb-4 flex flex-col gap-2",children:e.jsx("button",{className:"mt-2 bg-blue-600 text-white px-4 py-2 rounded font-semibold disabled:opacity-50",onClick:O,disabled:x||!h.length,children:"Optimize Route"})}),x&&e.jsx("div",{className:"text-blue-600",children:"Calculating..."}),o&&e.jsx("div",{className:"text-red-600 mb-2",children:o}),N.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Recommended Delivery Order:"}),e.jsx("ol",{className:"list-decimal ml-6",children:N.map((i,g)=>{const r=h.find(y=>y.order_id===i);return e.jsxs("li",{className:"mb-2",children:[e.jsx("span",{className:"font-mono text-xs",children:i})," ",r&&r.location&&e.jsx("span",{className:"text-xs text-gray-700",children:typeof r.location=="string"?r.location.slice(0,30):JSON.stringify(r.location).slice(0,30)})," ",p[i]&&e.jsxs("span",{className:"ml-2 text-green-700",children:["ETA: ",p[i]," min"]})]},i)})})]})]})}ae.createRoot(document.getElementById("root")).render(e.jsx(le.StrictMode,{children:e.jsx(ce,{})}));
